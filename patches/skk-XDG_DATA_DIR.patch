From 6c814d5e914f69289c2601022aebc9f92ecad971 Mon Sep 17 00:00:00 2001
From: ksqsf <i@ksqsf.moe>
Date: Sun, 7 Jan 2024 14:30:17 +0800
Subject: [PATCH] Support $XDG_DATA_DIR

---
 src/skk.cpp | 20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/src/skk.cpp b/src/skk.cpp
index 2606461..a78508a 100644
--- a/src/skk.cpp
+++ b/src/skk.cpp
@@ -501,30 +501,36 @@ void SkkEngine::loadDictionary() {
                 continue;
             }
             if (mode == 1) {
-                if (stringutils::endsWith(path, ".cdb")) {
+                constexpr char xdgDataDir[] = "$XDG_DATA_DIR/";
+                std::string realpath = path;
+                if (stringutils::startsWith(path, xdgDataDir)) {
+                    realpath = StandardPath::global().locate(
+                        StandardPath::Type::Data,
+                        path.substr(sizeof(xdgDataDir) - 1));
+                }
+                if (stringutils::endsWith(realpath, ".cdb")) {
                     SkkCdbDict *dict =
-                        skk_cdb_dict_new(path.data(), encoding.data(), nullptr);
+                        skk_cdb_dict_new(realpath.data(), encoding.data(), nullptr);
                     if (dict) {
-                        SKK_DEBUG() << "Adding cdb dict: " << path;
+                        SKK_DEBUG() << "Adding cdb dict: " << realpath;
                         dictionaries_.emplace_back(SKK_DICT(dict));
                     }
                 } else {
                     SkkFileDict *dict = skk_file_dict_new(
-                        path.data(), encoding.data(), nullptr);
+                        realpath.data(), encoding.data(), nullptr);
                     if (dict) {
-                        SKK_DEBUG() << "Adding file dict: " << path;
+                        SKK_DEBUG() << "Adding file dict: " << realpath;
                         dictionaries_.emplace_back(SKK_DICT(dict));
                     }
                 }
             } else {
                 constexpr char configDir[] = "$FCITX_CONFIG_DIR/";
-                constexpr auto len = sizeof(configDir) - 1;
                 std::string realpath = path;
                 if (stringutils::startsWith(path, configDir)) {
                     realpath = stringutils::joinPath(
                         StandardPath::global().userDirectory(
                             StandardPath::Type::PkgData),
-                        path.substr(len));
+                        path.substr(sizeof(configDir) - 1));
                 }
                 SkkUserDict *userdict = skk_user_dict_new(
                     realpath.data(), encoding.data(), nullptr);
-- 
2.39.3 (Apple Git-145)

